<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المتجر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .btn-primary { background-color: #2563eb; color: #ffffff; }
        .btn-danger { background-color: #dc2626; color: #ffffff; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loader" class="flex justify-center items-center h-screen">
        <p class="text-2xl">جاري التحقق من صلاحيات الدخول...</p>
    </div>

    <div id="admin-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">لوحة تحكم متجر المعرفة</h1>
                <button id="logout-button" class="text-gray-600 hover:text-blue-600">تسجيل الخروج</button>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <h2 class="text-3xl font-bold mb-6">إدارة المنتجات</h2>
            <div class="bg-white p-8 rounded-lg shadow-md mb-8">
                <h3 class="text-2xl font-bold mb-6">إضافة / تعديل منتج</h3>
                <form id="add-product-form">
                    <input type="hidden" id="product-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="product-name" class="block font-bold mb-2">اسم المنتج</label><input type="text" id="product-name" class="w-full px-4 py-2 border rounded-lg" required></div>
                        <div><label for="product-price" class="block font-bold mb-2">السعر (ر.س)</label><input type="number" id="product-price" class="w-full px-4 py-2 border rounded-lg" required></div>
                    </div>
                    <div class="mt-6"><label for="product-description" class="block font-bold mb-2">وصف المنتج</label><textarea id="product-description" rows="4" class="w-full px-4 py-2 border rounded-lg" required></textarea></div>
                    <div class="mt-6"><label for="product-image" class="block font-bold mb-2">رابط صورة المنتج</label><input type="url" id="product-image" class="w-full px-4 py-2 border rounded-lg" required></div>
                    <div class="mt-8 text-left"><button type="submit" class="btn-primary font-bold py-2 px-6 rounded-lg">حفظ المنتج</button><button type="button" id="cancel-edit-button" class="hidden font-bold py-2 px-6 rounded-lg ml-2 bg-gray-300">إلغاء</button></div>
                </form>
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h3 class="text-2xl font-bold mb-6">المنتجات الحالية</h3>
                <div class="overflow-x-auto"><table class="w-full text-right"><thead><tr class="bg-gray-200"><th class="p-4">اسم المنتج</th><th class="p-4">السعر</th><th class="p-4">الإجراءات</th></tr></thead><tbody id="products-table-body"></tbody></table></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyAK1uQl1yvfch7j5UCOQFDDMAuBWOY9w8",
                authDomain: "maarifa-store.firebaseapp.com",
                projectId: "maarifa-store",
                storageBucket: "maarifa-store.appspot.com",
                messagingSenderId: "940520390427",
                appId: "1:940520390427:web:1aaea5c259bdd94de9dbe"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            const loader = document.getElementById('loader');
            const adminContent = document.getElementById('admin-content');
            const logoutButton = document.getElementById('logout-button');
            const addProductForm = document.getElementById('add-product-form');
            const productsTableBody = document.getElementById('products-table-body');
            const productIdInput = document.getElementById('product-id'), productNameInput = document.getElementById('product-name'), productPriceInput = document.getElementById('product-price'), productDescriptionInput = document.getElementById('product-description'), productImageInput = document.getElementById('product-image'), cancelEditButton = document.getElementById('cancel-edit-button');

            auth.onAuthStateChanged(user => {
                if (user) {
                    loader.style.display = 'none';
                    adminContent.style.display = 'block';
                    renderAdminProducts();
                } else {
                    window.location.href = './login.html';
                }
            });

            logoutButton.addEventListener('click', () => auth.signOut());

            function renderAdminProducts() {
                db.collection("products").onSnapshot(snapshot => {
                    productsTableBody.innerHTML = '';
                    if (snapshot.empty) { productsTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-8">لا توجد منتجات.</td></tr>'; return; }
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `<td class="p-4">${product.name}</td><td class="p-4">${product.price} ر.س</td><td class="p-4"><button class="text-blue-600 hover:underline edit-btn" data-id="${doc.id}">تعديل</button><button class="text-red-600 hover:underline mr-4 delete-btn" data-id="${doc.id}">حذف</button></td>`;
                        productsTableBody.appendChild(row);
                    });
                });
            }

            addProductForm.addEventListener('submit', e => {
                e.preventDefault();
                const productData = { name: productNameInput.value, price: parseFloat(productPriceInput.value), description: productDescriptionInput.value, image: productImageInput.value };
                const id = productIdInput.value;
                const action = id ? db.collection("products").doc(id).update(productData) : db.collection("products").add(productData);
                action.then(() => {
                    alert(`تم ${id ? 'تحديث' : 'إضافة'} المنتج بنجاح!`);
                    addProductForm.reset();
                    productIdInput.value = '';
                    cancelEditButton.classList.add('hidden');
                }).catch(err => console.error(err));
            });

            productsTableBody.addEventListener('click', e => {
                const target = e.target;
                const id = target.dataset.id;
                if (target.classList.contains('delete-btn')) {
                    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                        db.collection("products").doc(id).delete().then(() => alert('تم الحذف!'));
                    }
                }
                if (target.classList.contains('edit-btn')) {
                    db.collection("products").doc(id).get().then(doc => {
                        if (doc.exists) {
                            const p = doc.data();
                            productIdInput.value = doc.id;
                            productNameInput.value = p.name;
                            productPriceInput.value = p.price;
                            productDescriptionInput.value = p.description;
                            productImageInput.value = p.image;
                            cancelEditButton.classList.remove('hidden');
                            window.scrollTo(0, 0);
                        }
                    });
                }
            });

            cancelEditButton.addEventListener('click', () => {
                addProductForm.reset();
                productIdInput.value = '';
                cancelEditButton.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
